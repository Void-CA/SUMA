WHITESPACE = _{ " " | "\t" | "\r" | "\n" }
COMMENT    = _{ "//" ~ (!"\n" ~ ANY)* }
// Nueva regla para comas opcionales
SEP        = _{ ","? } 

linear_algebra_block = { SOI ~ (system_def | analysis_def)* ~ EOI }

// --- DEFINICIÃ“N ---
// Agregamos SEP para permitir { A: [...], b: [...] }
system_def = { "LinearSystem" ~ name ~ "{" ~ (sys_property ~ SEP)* ~ "}" }

sys_property = { prop_a | prop_b }
// Reglas nombradas para parsing seguro
prop_a = { ("coefficients" | "A") ~ ":" ~ matrix_lit }
prop_b = { ("constants" | "b") ~ ":" ~ matrix_lit }

// --- QUERY ---
// Agregamos SEP y reglas nombradas
analysis_def = { "Analysis" ~ name ~ "{" ~ (query_property ~ SEP)* ~ "}" }

query_property = { prop_target | prop_calculate | prop_export }

prop_target    = { "target"    ~ ":" ~ name_ref }
prop_calculate = { "calculate" ~ ":" ~ prop_list }
prop_export    = { "export"    ~ ":" ~ export_map }

// --- PRIMITIVAS ---
prop_list   = { "[" ~ math_prop ~ ("," ~ math_prop)* ~ "]" }
math_prop   = { "determinant" | "solution" | "inverse" | "rank" | "trace" }

export_map  = { "{" ~ export_item ~ ("," ~ export_item)* ~ "}" }
export_item = { math_prop ~ "->" ~ ident }

name     = @{ string_lit | ident }
name_ref = @{ string_lit | ident } 

string_lit = @{ "\"" ~ (!"\"" ~ ANY)* ~ "\"" }
ident      = @{ ASCII_ALPHA ~ (ASCII_ALPHANUMERIC | "_")* }

matrix_lit = { "[" ~ row ~ (row_sep ~ row)* ~ "]" }
row        = { number ~ (col_sep ~ number)* }
row_sep    = _{ ";" }
col_sep    = _{ "," }
number     = @{ "-"? ~ ASCII_DIGIT+ ~ ("." ~ ASCII_DIGIT*)? }